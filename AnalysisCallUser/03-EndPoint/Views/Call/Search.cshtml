@model AnalysisCallUser._03_EndPoint.Models.ViewModels.Call.CallSearchViewModel
@{
    ViewData["Title"] = "جستجوی تماس";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h4>فیلترها</h4>
                </div>
                <div class="card-body">
                    <form asp-action="Search" method="post" id="filter-form">
                        @Html.AntiForgeryToken()

                        <!-- فیلدهای تاریخ -->
                        <div class="filter-section">
                            <div class="filter-section-title">بازه زمانی</div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.StartDate" class="form-label"></label>
                                    <input asp-for="Filter.StartDate" type="date" class="form-control" />
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.EndDate" class="form-label"></label>
                                    <input asp-for="Filter.EndDate" type="date" class="form-control" />
                                </div>
                            </div>
                        </div>

                        <!-- فیلدهای مبدأ -->
                        <div class="filter-section">
                            <div class="filter-section-title">مبدأ</div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.OriginCountryID" class="form-label"></label>
                                    <select asp-for="Filter.OriginCountryID" class="form-select" id="origin-country-select">
                                        <option value="">انتخاب کنید</option>
                                        @if (Model.Countries != null)
                                        {
                                            @foreach (var country in Model.Countries)
                                            {
                                                <option value="@country.CountryID">@country.CountryName</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.OriginCityID" class="form-label"></label>
                                    <select asp-for="Filter.OriginCityID" class="form-select" id="origin-city-select" disabled>
                                        <option value="">ابتدا کشور را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.ANumber" class="form-label"></label>
                                    <input asp-for="Filter.ANumber" class="form-control" placeholder="شماره مبدأ را وارد کنید" />
                                </div>
                            </div>
                        </div>

                        <!-- فیلدهای مقصد -->
                        <div class="filter-section">
                            <div class="filter-section-title">مقصد</div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.DestCountryID" class="form-label"></label>
                                    <select asp-for="Filter.DestCountryID" class="form-select" id="dest-country-select">
                                        <option value="">انتخاب کنید</option>
                                        @if (Model.Countries != null)
                                        {
                                            @foreach (var country in Model.Countries)
                                            {
                                                <option value="@country.CountryID">@country.CountryName</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.DestCityID" class="form-label"></label>
                                    <select asp-for="Filter.DestCityID" class="form-select" id="dest-city-select" disabled>
                                        <option value="">ابتدا کشور را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.BNumber" class="form-label"></label>
                                    <input asp-for="Filter.BNumber" class="form-control" placeholder="شماره مقصد را وارد کنید" />
                                </div>
                            </div>
                        </div>

                        <!-- فیلدهای دیگر -->
                        <div class="filter-section">
                            <div class="filter-section-title">سایر فیلترها</div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.Answer" class="form-label"></label>
                                    <select asp-for="Filter.Answer" class="form-select">
                                        <option value="">همه</option>
                                        <option value="@AnalysisCallUser._01_Domain.Core.Enums.CallAnswerStatus.Answered">پاسخ داده شده</option>
                                        <option value="@AnalysisCallUser._01_Domain.Core.Enums.CallAnswerStatus.NotAnswered">پاسخ داده نشده</option>
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.PageSize" class="form-label"></label>
                                    <select asp-for="Filter.PageSize" class="form-select">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- دکمه‌ها -->
                        <div class="filter-row">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="fas fa-search"></i> جستجو
                            </button>
                            <button type="button" id="reset-filter" class="btn btn-secondary flex-fill">بازنشانی</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div id="search-results-container">
                @if (Model.Results != null)
                {
                    <partial name="_SearchResults" model="Model.Results" />
                }
                else
                {
                    <div class="text-center p-4">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">برای جستجوی تماس‌ها، فیلترهای مورد نظر را اعمال کنید.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const originCountrySelect = document.getElementById('origin-country-select');
            const originCitySelect = document.getElementById('origin-city-select');
            const destCountrySelect = document.getElementById('dest-country-select');
            const destCitySelect = document.getElementById('dest-city-select');

            // تابع برای بارگذاری شهرها
            async function loadCities(countrySelect, citySelect) {
                const countryId = countrySelect.value;
                citySelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
                citySelect.disabled = true;

                if (!countryId) {
                    citySelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                    citySelect.disabled = true;
                    return;
                }

                try {
                    const response = await fetch(`/Call/GetCities?countryId=${countryId}`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const cities = await response.json();

                    citySelect.innerHTML = '<option value="">انتخاب کنید</option>';
                    cities.forEach(city => {
                        const option = new Option(city.cityName, city.cityID);
                        citySelect.add(option);
                    });
                    citySelect.disabled = false;
                } catch (error) {
                    console.error('Error loading cities:', error);
                    citySelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
                }
            }

            // رویداد برای کشور مبدأ
            originCountrySelect.addEventListener('change', () => loadCities(originCountrySelect, originCitySelect));
            // رویداد برای کشور مقصد
            destCountrySelect.addEventListener('change', () => loadCities(destCountrySelect, destCitySelect));

            // اگر در حالت POST-back هستیم و کشور انتخاب شده، شهرها را بارگذاری کن
            const originCountryId = '@Model.Filter.OriginCountryID';
            const destCountryId = '@Model.Filter.DestCountryID';

            if (originCountryId && originCountryId !== '') { // اضافه کردن شرط برای اطمینان از وجود مقدار
                loadCities(originCountrySelect, originCitySelect).then(() => {
                    originCitySelect.value = '@Model.Filter.OriginCityID';
                });
            }
            if (destCountryId && destCountryId !== '') { // اضافه کردن شرط برای اطمینان از وجود مقدار
                loadCities(destCountrySelect, destCitySelect).then(() => {
                    destCitySelect.value = '@Model.Filter.DestCityID';
                });
            }

            // ... بقیه اسکریپت‌های جستجو و ریست (بدون تغییر) ...
            document.getElementById('reset-filter').addEventListener('click', function() {
                document.getElementById('filter-form').reset();
                originCitySelect.disabled = true;
                originCitySelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                destCitySelect.disabled = true;
                destCitySelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                document.getElementById('search-results-container').innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">برای جستجوی تماس‌ها، فیلترهای مورد نظر را اعمال کنید.</p>
                    </div>
                `;
            });

            document.getElementById('filter-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const filterParams = new URLSearchParams();
                for (const pair of formData.entries()) {
                    if (pair[1]) {
                        filterParams.append(pair[0], pair[1]);
                    }
                }
                document.getElementById('search-results-container').innerHTML = `
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                        <p class="mt-2">در حال جستجو...</p>
                    </div>
                `;
                fetch('/Call/Search?' + filterParams.toString(), {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    document.getElementById('search-results-container').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('search-results-container').innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            خطا در دریافت نتایج جستجو. لطفاً دوباره تلاش کنید.
                        </div>
                    `;
                });
            });
        });
    </script>
}