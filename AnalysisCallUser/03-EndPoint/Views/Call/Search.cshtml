@model AnalysisCallUser._03_EndPoint.Models.ViewModels.Call.CallSearchViewModel
@{
    ViewData["Title"] = "جستجوی تماس";
}

<!-- اضافه کردن کتابخانه jQuery که برای تقویم شمسی ضروری است -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- افزودن کتابخانه تقویم شمسی -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@0.4.5/dist/css/persian-datepicker.min.css" />
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@0.4.5/dist/js/persian-datepicker.min.js"></script>

<style>
    /* استایل برای پس‌زمینه مودال با شفافیت کمتر */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.7) !important;
    }

    /* حذف حالت شیشه‌ای از محتوای مودال */
    .modal-content {
        background-color: #2a2a3e !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">فیلترها</h4>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filterCardBody" aria-expanded="true" aria-controls="filterCardBody">
                        <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>
                <div class="card-body collapse show" id="filterCardBody">
                    <form asp-action="Search" method="post" id="filter-form" novalidate>
                        @Html.AntiForgeryToken()

                        <!-- فیلدهای تاریخ -->
                        <div class="filter-section">
                            <div class="filter-section-title">
                                <i class="fas fa-calendar-alt"></i> بازه زمانی
                                <button type="button" class="btn btn-sm btn-outline-info float-end" id="datePresetsBtn" data-bs-toggle="dropdown">
                                    <i class="fas fa-clock"></i> پیش‌فرض
                                </button>
                                <ul class="dropdown-menu" id="datePresets">
                                    <li><a class="dropdown-item" href="#" data-days="1">امروز</a></li>
                                    <li><a class="dropdown-item" href="#" data-days="7">۷ روز گذشته</a></li>
                                    <li><a class="dropdown-item" href="#" data-days="30">۳۰ روز گذشته</a></li>
                                    <li><a class="dropdown-item" href="#" data-days="90">۳ ماه گذشته</a></li>
                                </ul>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.StartDate" class="form-label"></label>
                                    <div class="input-group">
                                        <input asp-for="Filter.StartDate" type="text" class="form-control persian-date-input" placeholder="تاریخ شروع" id="Filter_StartDate" maxlength="10" />
                                        <span class="input-group-text" id="startDateClear">
                                            <i class="fas fa-times"></i>
                                        </span>
                                    </div>
                                    <div class="text-danger small" id="startDateError"></div>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.EndDate" class="form-label"></label>
                                    <div class="input-group">
                                        <input asp-for="Filter.EndDate" type="text" class="form-control persian-date-input" placeholder="تاریخ پایان" id="Filter_EndDate" maxlength="10" />
                                        <span class="input-group-text" id="endDateClear">
                                            <i class="fas fa-times"></i>
                                        </span>
                                    </div>
                                    <div class="text-danger small" id="endDateError"></div>
                                </div>
                            </div>
                        </div>

                        <!-- فیلدهای مبدأ -->
                        <div class="filter-section">
                            <div class="filter-section-title">
                                <i class="fas fa-phone-alt"></i> مبدأ
                                <button type="button" class="btn btn-sm btn-outline-info float-end" id="swapOriginDest">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.OriginCountryID" class="form-label"></label>
                                    <select asp-for="Filter.OriginCountryID" class="form-select" id="origin-country-select">
                                        <option value="">انتخاب کنید</option>
                                        @if (Model.Countries != null)
                                        {
                                            @foreach (var country in Model.Countries)
                                            {
                                                <option value="@country.CountryID">@country.CountryName</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.OriginCityID" class="form-label"></label>
                                    <select asp-for="Filter.OriginCityID" class="form-select" id="origin-city-select" disabled>
                                        <option value="">ابتدا کشور را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.OriginOperatorID" class="form-label"></label>
                                    <select asp-for="Filter.OriginOperatorID" class="form-select" id="origin-operator-select" disabled>
                                        <option value="">ابتدا کشور را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.ANumber" class="form-label"></label>
                                    <div class="input-group">
                                        <input asp-for="Filter.ANumber" class="form-control" placeholder="شماره مبدأ را وارد کنید" id="anumber-input" />
                                        <button class="btn btn-outline-secondary" type="button" id="detectOriginBtn" title="تشخیص خودکار کشور و اپراتور">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- فیلدهای مقصد -->
                        <div class="filter-section">
                            <div class="filter-section-title">
                                <i class="fas fa-phone-alt"></i> مقصد
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.DestCountryID" class="form-label"></label>
                                    <select asp-for="Filter.DestCountryID" class="form-select" id="dest-country-select">
                                        <option value="">انتخاب کنید</option>
                                        @if (Model.Countries != null)
                                        {
                                            @foreach (var country in Model.Countries)
                                            {
                                                <option value="@country.CountryID">@country.CountryName</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.DestCityID" class="form-label"></label>
                                    <select asp-for="Filter.DestCityID" class="form-select" id="dest-city-select" disabled>
                                        <option value="">ابتدا کشور را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.DestOperatorID" class="form-label"></label>
                                    <select asp-for="Filter.DestOperatorID" class="form-select" id="dest-operator-select" disabled>
                                        <option value="">ابتدا کشور را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.BNumber" class="form-label"></label>
                                    <div class="input-group">
                                        <input asp-for="Filter.BNumber" class="form-control" placeholder="شماره مقصد را وارد کنید" id="bnumber-input" />
                                        <button class="btn btn-outline-secondary" type="button" id="detectDestBtn" title="تشخیص خودکار کشور و اپراتور">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- فیلدهای دیگر -->
                        <div class="filter-section">
                            <div class="filter-section-title">
                                <i class="fas fa-filter"></i> سایر فیلترها
                            </div>
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label asp-for="Filter.Answer" class="form-label"></label>
                                    <select asp-for="Filter.Answer" class="form-select" id="answer-select">
                                        <option value="">همه</option>
                                        <option value="@AnalysisCallUser._01_Domain.Core.Enums.CallAnswerStatus.Answered">پاسخ داده شده</option>
                                        <option value="@AnalysisCallUser._01_Domain.Core.Enums.CallAnswerStatus.NotAnswered">پاسخ داده نشده</option>
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label asp-for="Filter.PageSize" class="form-label"></label>
                                    <select asp-for="Filter.PageSize" class="form-select">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- دکمه‌ها -->
                        <div class="filter-section">
                            <div class="filter-row">
                                <button type="submit" class="btn btn-primary flex-fill">
                                    <i class="fas fa-search"></i> جستجو
                                </button>
                                <button type="button" id="reset-filter" class="btn btn-secondary flex-fill">
                                    <i class="fas fa-redo"></i> بازنشانی
                                </button>
                            </div>
                            <div class="filter-row mt-2">
                                <button type="button" id="export-results" class="btn btn-success flex-fill" disabled>
                                    <i class="fas fa-file-export"></i> خروجی اکسل
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div id="search-results-container">
                @if (Model.Results != null)
                {
                    <partial name="_SearchResults" model="Model.Results" />
                }
                else
                {
                    <div class="text-center p-4">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">برای جستجوی تماس‌ها، فیلترهای مورد نظر را اعمال کنید.</p>
                        <div class="mt-3">
                            <button class="btn btn-outline-primary" id="quickSearchBtn">
                                <i class="fas fa-bolt"></i> جستجوی سریع (تماس‌های امروز)
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-info-circle text-primary me-2"></i>
            <strong class="me-auto">اطلاعیه</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            پیام اطلاع‌رسانی
        </div>
    </div>
</div>

<!-- Modal for export options -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">اکسپورت نتایج جستجو</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- گزینه‌های اکسپورت -->
                <div class="mb-3">
                    <label class="form-label">نوع اکسپورت</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportType" id="exportAll" value="all" checked>
                        <label class="form-check-label" for="exportAll">
                          تمام نتایج فیلتر شده بر اساس تعداد ردیف مشخص شده 
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportType" id="exportCurrent" value="current">
                        <label class="form-check-label" for="exportCurrent">
                          تمامی نتایج فیلتر شده 
                        </label>
                    </div>
                </div>

                <!-- بخش مربوط به تمام نتایج -->
                <div id="allResultsSection">
                    <div class="mb-3">
                        <label class="form-label">تعداد کل رکوردها: <span id="totalRecords" class="badge bg-primary">100</span></label>
                    </div>

                    <div class="mb-3">
                        <label for="exportLimit" class="form-label">محدودیت تعداد رکوردها برای اکسپورت</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="exportLimit" min="1" max="10000" value="100">
                            <span class="input-group-text">ردیف</span>
                        </div>
                        <div class="form-text">حداکثر حجم فایل: <span id="estimatedSize">0</span> MB (حداکثر مجاز: 50MB)</div>
                    </div>
                </div>

                <!-- بخش مربوط به نتایج نمایش داده شده -->
                <div id="currentResultsSection" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label">تعداد رکوردهای نمایش داده شده: <span id="currentRecords" class="badge bg-info">50</span></label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ستون‌های مورد نظر برای اکسپورت</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colDetailID" checked>
                        <label class="form-check-label" for="colDetailID">شناسه تماس</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colANumber" checked>
                        <label class="form-check-label" for="colANumber">شماره مبدأ</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colBNumber" checked>
                        <label class="form-check-label" for="colBNumber">شماره مقصد</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colAccountingTime" checked>
                        <label class="form-check-label" for="colAccountingTime">تاریخ و زمان</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colLength" checked>
                        <label class="form-check-label" for="colLength">مدت زمان (ثانیه)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colOriginCountry" checked>
                        <label class="form-check-label" for="colOriginCountry">کشور مبدأ</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colOriginCity">
                        <label class="form-check-label" for="colOriginCity">شهر مبدأ</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colOriginOperator">
                        <label class="form-check-label" for="colOriginOperator">اپراتور مبدأ</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colDestCountry" checked>
                        <label class="form-check-label" for="colDestCountry">کشور مقصد</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colDestCity">
                        <label class="form-check-label" for="colDestCity">شهر مقصد</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colDestOperator">
                        <label class="form-check-label" for="colDestOperator">اپراتور مقصد</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="colAnswer" checked>
                        <label class="form-check-label" for="colAnswer">وضعیت پاسخ</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-primary" id="confirmExport">اکسپورت</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // تعریف متغیرها
            const originCountrySelect = document.getElementById('origin-country-select');
            const originCitySelect = document.getElementById('origin-city-select');
            const destCountrySelect = document.getElementById('dest-country-select');
            const destCitySelect = document.getElementById('dest-city-select');
            const originOperatorSelect = document.getElementById('origin-operator-select');
            const destOperatorSelect = document.getElementById('dest-operator-select');
            const aNumberInput = document.getElementById('anumber-input');
            const bNumberInput = document.getElementById('bnumber-input');
            const startDateInput = document.getElementById('Filter_StartDate');
            const endDateInput = document.getElementById('Filter_EndDate');
            const startDateError = document.getElementById('startDateError');
            const endDateError = document.getElementById('endDateError');
            const answerSelect = document.getElementById('answer-select');
            const resetBtn = document.getElementById('reset-filter');
            const exportBtn = document.getElementById('export-results');
            const quickSearchBtn = document.getElementById('quickSearchBtn');
            const filterForm = document.getElementById('filter-form');
            const searchResultsContainer = document.getElementById('search-results-container');
            const filterToggleIcon = document.getElementById('filterToggleIcon');
            const swapOriginDestBtn = document.getElementById('swapOriginDest');
            const detectOriginBtn = document.getElementById('detectOriginBtn');
            const detectDestBtn = document.getElementById('detectDestBtn');
            const startDateClear = document.getElementById('startDateClear');
            const endDateClear = document.getElementById('endDateClear');
            const datePresetsBtn = document.getElementById('datePresetsBtn');
            const notificationToast = new bootstrap.Toast(document.getElementById('notificationToast'));
            const toastMessage = document.getElementById('toastMessage');

            // متغیرهای مربوط به مودال اکسپورت
            const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
            const exportLimitInput = document.getElementById('exportLimit');
            const totalRecordsSpan = document.getElementById('totalRecords');
            const currentRecordsSpan = document.getElementById('currentRecords');
            const estimatedSizeSpan = document.getElementById('estimatedSize');
            const confirmExportBtn = document.getElementById('confirmExport');
            const exportAllRadio = document.getElementById('exportAll');
            const exportCurrentRadio = document.getElementById('exportCurrent');
            const allResultsSection = document.getElementById('allResultsSection');
            const currentResultsSection = document.getElementById('currentResultsSection');

            // متغیر برای نگهداری تعداد کل نتایج
            let totalResultsCount = 0;
            let currentPageResultsCount = 0;

            // --- تعریف توابع ---

            // تابع کمکی برای تبدیل ارقام فارسی به انگلیسی
            function toEnglishDigits(s) {
                return s.toString().replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
            }

            // تابع برای نمایش اعلان
            function showToast(message, type = 'info') {
                toastMessage.textContent = message;
                const toastHeader = document.querySelector('#notificationToast .toast-header i');
                toastHeader.className = `fas me-2 ${type === 'success' ? 'fa-check-circle text-success' : type === 'error' ? 'fa-exclamation-circle text-danger' : 'fa-info-circle text-primary'}`;
                notificationToast.show();
            }

            // تابع برای تخمین حجم فایل
            function estimateFileSize(recordCount, columnCount) {
                const estimatedBytes = recordCount * columnCount * 100;
                const estimatedMB = (estimatedBytes / (1024 * 1024)).toFixed(2);
                return estimatedMB;
            }

            // تابع برای شمارش ستون‌های انتخاب شده
            function countSelectedColumns() {
                const checkboxes = document.querySelectorAll('#exportModal .form-check-input[type="checkbox"]');
                let count = 0;
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) count++;
                });
                return count;
            }

            // تابع برای به‌روزرسانی تخمین حجم فایل
            function updateEstimatedSize() {
                const limit = parseInt(exportLimitInput.value) || 0;
                const columnCount = countSelectedColumns();
                const estimatedSize = estimateFileSize(limit, columnCount);
                estimatedSizeSpan.textContent = estimatedSize;

                if (estimatedSize > 50) {
                    estimatedSizeSpan.classList.add('text-danger');
                    confirmExportBtn.disabled = true;
                } else {
                    estimatedSizeSpan.classList.remove('text-danger');
                    confirmExportBtn.disabled = false;
                }
            }

            // تابع برای به‌روزرسانی تعداد رکوردهای نمایش داده شده
            function updateCurrentRecordsCount() {
                // شمارش ردیف‌های جدول در صفحه
                const tableRows = document.querySelectorAll('#search-results-container .table tbody tr');
                currentPageResultsCount = tableRows.length;
                currentRecordsSpan.textContent = currentPageResultsCount;
            }

            // تابع برای تغییر حالت نمایش بخش‌های مودال بر اساس نوع اکسپورت
            function toggleExportSections() {
                if (exportAllRadio.checked) {
                    allResultsSection.style.display = 'block';
                    currentResultsSection.style.display = 'none';
                    updateEstimatedSize();
                } else {
                    allResultsSection.style.display = 'none';
                    currentResultsSection.style.display = 'block';
                    updateCurrentRecordsCount();
                }
            }

            // تابع برای تبدیل تاریخ‌ها به شمسی
            function convertDatesToPersian() {
                if (typeof persianDate === 'undefined') {
                    console.error("persianDate library is not loaded. Dates will not be converted.");
                    return;
                }
                const dateElements = document.querySelectorAll('.datetime-cell, [data-datetime]');
                dateElements.forEach(element => {
                    if (element.dataset.datetime) {
                        const date = new Date(element.dataset.datetime);
                        element.textContent = new persianDate(date).format('YYYY/MM/DD HH:mm:ss');
                    }
                });
            }

            // تابع برای بارگذاری شهرها
            async function loadCities(countrySelect, citySelect) {
                const countryId = countrySelect.value;
                citySelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
                citySelect.disabled = true;

                if (!countryId) {
                    citySelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                    citySelect.disabled = true;
                    return;
                }

                try {
                    const response = await fetch(`/Call/GetCities?countryId=${countryId}`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const cities = await response.json();

                    citySelect.innerHTML = '<option value="">انتخاب کنید</option>';
                    cities.forEach(city => {
                        const option = new Option(city.cityName, city.cityID);
                        citySelect.add(option);
                    });
                    citySelect.disabled = false;
                } catch (error) {
                    console.error('Error loading cities:', error);
                    citySelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
                    showToast('خطا در بارگذاری شهرها', 'error');
                }
            }

            // تابع برای بارگذاری اپراتورها
            async function loadOperators(countrySelect, operatorSelect) {
                const countryId = countrySelect.value;
                operatorSelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
                operatorSelect.disabled = true;

                if (!countryId) {
                    operatorSelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                    operatorSelect.disabled = true;
                    return;
                }

                try {
                    const response = await fetch(`/Call/GetOperators?countryId=${countryId}`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const operators = await response.json();

                    operatorSelect.innerHTML = '<option value="">انتخاب کنید</option>';
                    operators.forEach(op => {
                        const option = new Option(op.operatorName, op.operatorID);
                        operatorSelect.add(option);
                    });
                    operatorSelect.disabled = false;
                } catch (error) {
                    console.error('Error loading operators:', error);
                    operatorSelect.innerHTML = '<option value="">خطا در بارگذاری</option>';
                    showToast('خطا در بارگذاری اپراتورها', 'error');
                }
            }

            // تابع برای پر کردن فیلدها بر اساس اطلاعات شماره
            async function populateFieldsFromPhoneInfo(phoneNumber, countrySelectId, citySelectId, operatorSelectId) {
                if (!phoneNumber || phoneNumber.length < 5) return;

                try {
                    showToast('در حال تشخیص اطلاعات شماره تلفن...');
                    const response = await fetch(`/Call/GetPhoneInfo?number=${encodeURIComponent(phoneNumber)}`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const info = await response.json();

                    if (!info.success) {
                        showToast('اطلاعات شماره تلفن یافت نشد', 'error');
                        return;
                    }

                    const countrySelect = document.getElementById(countrySelectId);
                    const citySelect = document.getElementById(citySelectId);
                    const operatorSelect = document.getElementById(operatorSelectId);

                    if (info.countryId) {
                        countrySelect.value = info.countryId;
                        const countryChangeEvent = new Event('change', { bubbles: true });
                        countrySelect.dispatchEvent(countryChangeEvent);
                    }

                    setTimeout(() => {
                        if (info.cityId) citySelect.value = info.cityId;
                        if (info.operatorId) operatorSelect.value = info.operatorId;
                        showToast('اطلاعات شماره تلفن با موفقیت تشخیص داده شد', 'success');
                    }, 400);

                } catch (error) {
                    console.error('Error fetching phone info:', error);
                    showToast('خطا در تشخیص اطلاعات شماره تلفن', 'error');
                }
            }

            // تابع برای جستجو (منطق اصلی بدون تغییر)
            async function performSearch() {
                const formData = new FormData(filterForm);

                // اطمینان از ارسال صحیح مقدار Answer
                if (answerSelect) {
                    formData.set('Filter.Answer', answerSelect.value);
                }

                searchResultsContainer.innerHTML = `
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                        <p class="mt-2">در حال جستجو...</p>
                    </div>
                `;

                try {
                    const response = await fetch(`/Call/Search`, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });

                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);

                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const errorData = await response.json();
                        console.error("Server-side validation errors:", errorData);
                        searchResultsContainer.innerHTML = `<div class="alert alert-danger" role="alert">خطای اعتبارسنجی در سرور. جزئیات در کنسول.</div>`;
                        showToast('خطای اعتبارسنجی', 'error');
                        return;
                    }

                    const html = await response.text();
                    if (html.includes('<html') || html.includes('<!DOCTYPE')) {
                        console.error("Error: Received full page HTML instead of partial view.");
                        searchResultsContainer.innerHTML = `<div class="alert alert-danger" role="alert">خطا در سرور. (Full page received)</div>`;
                        showToast('خطا در جستجو', 'error');
                        return;
                    }

                    searchResultsContainer.innerHTML = html;
                    exportBtn.disabled = false;
                    convertDatesToPersian();

                    const totalCountMatch = html.match(/نتایج جستجو \((\d+) رکورد\)/);
                    if (totalCountMatch) {
                        totalResultsCount = parseInt(totalCountMatch[1]);
                    }

                    // به‌روزرسانی تعداد رکوردهای نمایش داده شده
                    updateCurrentRecordsCount();

                } catch (error) {
                    console.error('Error during search fetch:', error);
                    searchResultsContainer.innerHTML = `<div class="alert alert-danger" role="alert">خطا در دریافت نتایج جستجو. (${error.message})</div>`;
                    showToast('خطا در جستجو', 'error');
                }
            }

            // تابع برای اکسپورت با گزینه‌های انتخاب شده
            async function performExportWithOptions() {
                const formData = new FormData(filterForm);
                const exportType = document.querySelector('input[name="exportType"]:checked').value;

                // اضافه کردن نوع اکسپورت به فرم
                formData.append('exportType', exportType);

                // اگر اکسپورت تمام نتایج انتخاب شده باشد
                if (exportType === 'all') {
                    formData.append('limit', exportLimitInput.value);
                }

                // اطمینان از ارسال صحیح مقدار Answer
                if (answerSelect) {
                    formData.set('Filter.Answer', answerSelect.value);
                }

                const columns = [];
                if (document.getElementById('colDetailID').checked) columns.push('DetailID');
                if (document.getElementById('colANumber').checked) columns.push('ANumber');
                if (document.getElementById('colBNumber').checked) columns.push('BNumber');
                if (document.getElementById('colAccountingTime').checked) columns.push('AccountingTime');
                if (document.getElementById('colLength').checked) columns.push('Length');
                if (document.getElementById('colOriginCountry').checked) columns.push('OriginCountryName');
                if (document.getElementById('colOriginCity').checked) columns.push('OriginCityName');
                if (document.getElementById('colOriginOperator').checked) columns.push('OriginOperatorName');
                if (document.getElementById('colDestCountry').checked) columns.push('DestCountryName');
                if (document.getElementById('colDestCity').checked) columns.push('DestCityName');
                if (document.getElementById('colDestOperator').checked) columns.push('DestOperatorName');
                if (document.getElementById('colAnswer').checked) columns.push('Answer');
                formData.append('columns', columns.join(','));

                try {
                    const response = await fetch(`/Call/ExportWithOptions`, {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value,
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });

                    if (!response.ok) throw new Error('Network response was not ok.');

                    exportModal.hide();
                    showToast('در حال آماده‌سازی فایل اکسپورت...');

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const exportTypeText = exportType === 'all' ? 'All' : 'Current';
                    a.download = `CallExport_${exportTypeText}_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showToast('خروجی با موفقیت دانلود شد', 'success');
                } catch (error) {
                    console.error('Error:', error);
                    showToast('خطا در آماده‌سازی خروجی', 'error');
                }
            }

            // تابع برای قالب‌بندی و اعتبارسنجی تاریخ (غیرمسدودکننده)
            function formatDateInput(input) {
                // تبدیل ارقام فارسی به انگلیسی
                let value = toEnglishDigits(input.value);

                // حذف تمام کاراکترهای غیر عددی
                value = value.replace(/[^\d]/g, '');

                // محدودیت طول به 10 کاراکتر (YYYY/MM/DD)
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }

                // افزودن اسلش بعد از سال و ماه
                if (value.length > 4) {
                    value = value.substring(0, 4) + '/' + value.substring(4);
                }
                if (value.length > 7) {
                    value = value.substring(0, 7) + '/' + value.substring(7);
                }

                input.value = value;
            }

            // تابع برای اعتبارسنجی و نمایش خطا (غیرمسدودکننده)
            function validateDate(input, errorElement) {
                const value = input.value;

                // اگر خالی باشد، خطا را پاک کن و خارج شو
                if (!value) {
                    errorElement.textContent = '';
                    return;
                }

                // بررسی فرمت YYYY/MM/DD
                const datePattern = /^(\d{4})\/(\d{2})\/(\d{2})$/;
                if (!datePattern.test(value)) {
                    errorElement.textContent = 'فرمت تاریخ باید به صورت YYYY/MM/DD باشد';
                    return;
                }

                const match = value.match(datePattern);
                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);

                // بررسی سال
                const currentYear = new persianDate().year();
                if (year < 1390) {
                    errorElement.textContent = 'سال نباید کمتر از 1390 باشد';
                    return;
                }

                if (year > currentYear) {
                    errorElement.textContent = 'سال نباید از سال جاری بیشتر باشد';
                    return;
                }

                // بررسی ماه
                if (month < 1 || month > 12) {
                    errorElement.textContent = 'ماه باید بین 1 تا 12 باشد';
                    return;
                }

                // بررسی روز
                if (day < 1 || day > 31) {
                    errorElement.textContent = 'روز باید بین 1 تا 31 باشد';
                    return;
                }

                // بررسی روزهای مجاز برای ماه‌های مختلف
                if (month >= 7 && month <= 11 && day > 30) {
                    errorElement.textContent = 'این ماه حداکثر 30 روز دارد';
                    return;
                }

                // بررسی سال کبیسه برای اسفند
                if (month === 12) {
                    const isLeapYear = (year % 4 === 3);
                    const maxDay = isLeapYear ? 30 : 29;
                    if (day > maxDay) {
                        errorElement.textContent = `اسفند در سال ${year} حداکثر ${maxDay} روز دارد`;
                        return;
                    }
                }

                // بررسی اینکه تاریخ از امروز بیشتر نباشد
                const today = new persianDate();
                const inputDate = new persianDate([year, month, day]);

                if (inputDate.isAfter(today)) {
                    errorElement.textContent = 'تاریخ نباید از امروز بیشتر باشد';
                    return;
                }

                // اگر همه چیز درست بود، خطا را پاک کن
                errorElement.textContent = '';
            }

            // --- اتصال رویدادها ---

            // رویداد برای کشور مبدأ
            originCountrySelect.addEventListener('change', () => {
                loadCities(originCountrySelect, originCitySelect);
                loadOperators(originCountrySelect, originOperatorSelect);
            });

            // رویداد برای کشور مقصد
            destCountrySelect.addEventListener('change', () => {
                loadCities(destCountrySelect, destCitySelect);
                loadOperators(destCountrySelect, destOperatorSelect);
            });

            // رویداد برای دکمه‌های تشخیص خودکار
            detectOriginBtn.addEventListener('click', () => {
                populateFieldsFromPhoneInfo(aNumberInput.value, 'origin-country-select', 'origin-city-select', 'origin-operator-select');
            });

            detectDestBtn.addEventListener('click', () => {
                populateFieldsFromPhoneInfo(bNumberInput.value, 'dest-country-select', 'dest-city-select', 'dest-operator-select');
            });

            // رویداد برای پاک کردن تاریخ‌ها
            startDateClear.addEventListener('click', () => {
                startDateInput.value = '';
                startDateError.textContent = '';
            });
            endDateClear.addEventListener('click', () => {
                endDateInput.value = '';
                endDateError.textContent = '';
            });

            // رویداد برای جابجایی مبدأ و مقصد
            swapOriginDestBtn.addEventListener('click', () => {
                const tempCountry = originCountrySelect.value;
                originCountrySelect.value = destCountrySelect.value;
                destCountrySelect.value = tempCountry;
                originCountrySelect.dispatchEvent(new Event('change'));
                destCountrySelect.dispatchEvent(new Event('change'));
                setTimeout(() => {
                    const tempCity = originCitySelect.value;
                    originCitySelect.value = destCitySelect.value;
                    destCitySelect.value = tempCity;
                    const tempOperator = originOperatorSelect.value;
                    originOperatorSelect.value = destOperatorSelect.value;
                    destOperatorSelect.value = tempOperator;
                }, 500);
                const tempANumber = aNumberInput.value;
                aNumberInput.value = bNumberInput.value;
                bNumberInput.value = tempANumber;

                // جابجایی خطاهای تاریخ
                const tempError = startDateError.textContent;
                startDateError.textContent = endDateError.textContent;
                endDateError.textContent = tempError;

                showToast('مبدأ و مقصد با موفقیت جابجا شدند', 'success');
            });

            document.querySelectorAll('#datePresets .dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const days = parseInt(this.getAttribute('data-days'));
                    if (typeof persianDate !== 'undefined') {
                        const today = new persianDate();
                        const startDate = new persianDate().subtract('days', days);
                        startDateInput.value = toEnglishDigits(startDate.format('YYYY/MM/DD'));
                        endDateInput.value = toEnglishDigits(today.format('YYYY/MM/DD'));

                        // پاک کردن خطاهای تاریخ
                        startDateError.textContent = '';
                        endDateError.textContent = '';
                    }
                    showToast(`بازه زمانی به ${this.textContent} تنظیم شد`, 'success');
                });
            });

            quickSearchBtn.addEventListener('click', () => {
                if (typeof persianDate !== 'undefined') {
                    const today = new persianDate();
                    const dateStr = toEnglishDigits(today.format('YYYY/MM/DD'));
                    startDateInput.value = dateStr;
                    endDateInput.value = dateStr;

                    // پاک کردن خطاهای تاریخ
                    startDateError.textContent = '';
                    endDateError.textContent = '';
                }
                performSearch();
            });

            resetBtn.addEventListener('click', function() {
                filterForm.reset();
                originCitySelect.disabled = true; originCitySelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                destCitySelect.disabled = true; destCitySelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                originOperatorSelect.disabled = true; originOperatorSelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                destOperatorSelect.disabled = true; destOperatorSelect.innerHTML = '<option value="">ابتدا کشور را انتخاب کنید</option>';
                exportBtn.disabled = true;

                // پاک کردن خطاهای تاریخ
                startDateError.textContent = '';
                endDateError.textContent = '';

                searchResultsContainer.innerHTML = `<div class="text-center p-4"><i class="fas fa-search fa-3x text-muted mb-3"></i><p class="text-muted">برای جستجوی تماس‌ها، فیلترهای مورد نظر را اعمال کنید.</p><div class="mt-3"><button class="btn btn-outline-primary" id="quickSearchBtn"><i class="fas fa-bolt"></i> جستجوی سریع (تماس‌های امروز)</button></div></div>`;
                document.getElementById('quickSearchBtn').addEventListener('click', () => {
                    if (typeof persianDate !== 'undefined') {
                        const today = new persianDate();
                        const dateStr = toEnglishDigits(today.format('YYYY/MM/DD'));
                        startDateInput.value = dateStr;
                        endDateInput.value = dateStr;
                    }
                    performSearch();
                });
                showToast('فیلترها با موفقیت بازنشانی شدند', 'success');
            });

            exportBtn.addEventListener('click', () => {
                totalRecordsSpan.textContent = totalResultsCount;
                exportLimitInput.value = totalResultsCount > 0 ? Math.min(totalResultsCount, 1000) : 100;
                updateCurrentRecordsCount();
                updateEstimatedSize();
                exportModal.show();
            });

            confirmExportBtn.addEventListener('click', () => {
                performExportWithOptions();
            });

            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                performSearch();
            });

            document.querySelector('[data-bs-toggle="collapse"]').addEventListener('click', function() {
                filterToggleIcon.classList.toggle('fa-chevron-up');
                filterToggleIcon.classList.toggle('fa-chevron-down');
            });

            exportLimitInput.addEventListener('input', updateEstimatedSize);

            document.querySelectorAll('#exportModal .form-check-input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateEstimatedSize);
            });

            // رویدادهای مربوط به تغییر نوع اکسپورت
            exportAllRadio.addEventListener('change', toggleExportSections);
            exportCurrentRadio.addEventListener('change', toggleExportSections);

            aNumberInput.addEventListener('blur', () => { populateFieldsFromPhoneInfo(aNumberInput.value, 'origin-country-select', 'origin-city-select', 'origin-operator-select'); });
            bNumberInput.addEventListener('blur', () => { populateFieldsFromPhoneInfo(bNumberInput.value, 'dest-country-select', 'dest-city-select', 'dest-operator-select'); });

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') { e.preventDefault(); performSearch(); }
                if (e.ctrlKey && e.key === 'r') { e.preventDefault(); resetBtn.click(); }
            });

            // رویدادهای مربوط به ورود تاریخ
            startDateInput.addEventListener('input', function() {
                formatDateInput(this);
            });

            startDateInput.addEventListener('blur', function() {
                validateDate(this, startDateError);
            });

            endDateInput.addEventListener('input', function() {
                formatDateInput(this);
            });

            endDateInput.addEventListener('blur', function() {
                validateDate(this, endDateError);
            });

            const originCountryId = '@Model.Filter.OriginCountryID';
            const destCountryId = '@Model.Filter.DestCountryID';

            if (originCountryId && originCountryId !== '') {
                Promise.all([loadCities(originCountrySelect, originCitySelect), loadOperators(originCountrySelect, originOperatorSelect)]).then(() => {
                    originCitySelect.value = '@Model.Filter.OriginCityID';
                    originOperatorSelect.value = '@Model.Filter.OriginOperatorID';
                });
            }
            if (destCountryId && destCountryId !== '') {
                Promise.all([loadCities(destCountrySelect, destCitySelect), loadOperators(destCountrySelect, destOperatorSelect)]).then(() => {
                    destCitySelect.value = '@Model.Filter.DestCityID';
                    destOperatorSelect.value = '@Model.Filter.DestOperatorID';
                });
            }

            @if (Model.Results != null)
            {
                                                <text>
                                                    exportBtn.disabled = false;
                                                    totalResultsCount = @Model.Results.TotalCount;
                                                </text>
            }

            if (typeof $ !== 'undefined' && $.fn.persianDatepicker) {
                $(startDateInput).persianDatepicker({
                    format: 'YYYY/MM/DD', autoClose: true, observer: true, initialValue: false,
                    onSelect: function() {
                        const persianDateString = $(this).val();
                        const englishDateString = toEnglishDigits(persianDateString);
                        $(this).val(englishDateString);
                        $(this).trigger('change');
                        validateDate(this, startDateError);
                    }
                });
                $(endDateInput).persianDatepicker({
                    format: 'YYYY/MM/DD', autoClose: true, observer: true, initialValue: false,
                    onSelect: function() {
                        const persianDateString = $(this).val();
                        const englishDateString = toEnglishDigits(persianDateString);
                        $(this).val(englishDateString);
                        $(this).trigger('change');
                        validateDate(this, endDateError);
                    }
                });
            } else {
                console.warn("jQuery or persianDatepicker is not loaded. Date pickers will not be initialized.");
            }

            convertDatesToPersian();
        });
    </script>
}