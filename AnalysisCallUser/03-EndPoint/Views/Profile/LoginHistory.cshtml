@model IEnumerable<AnalysisCallUser._01_Domain.Core.Entities.UserLoginHistory>

@{
    ViewData["Title"] = "تاریخچه ورود";
}

<div class="login-history-container">
    <div class="page-header">
        <h3>تاریخچه ورود</h3>
        <div class="page-actions">
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> بازگشت به پروفایل
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5>سوابق ورود به سیستم</h5>
            <div class="card-tools">
                <button id="refresh-history" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt"></i> به‌روزرسانی
                </button>
                <button id="export-history" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-download"></i> خروجی
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>تاریخ و زمان</th>
                            <th>IP آدرس</th>
                            <th>مرورگر</th>
                            <th>سیستم‌عامل</th>
                            <th>موقعیت جغرافیایی</th>
                            <th>وضعیت</th>
                            <th>عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var login in Model)
                            {
                                <tr>
                                    <td>@login.LoginTime.ToString("yyyy/MM/dd HH:mm:ss")</td>
                                    <td>@login.IpAddress</td>
                                  
                                    <td>
                                        @if (login.IsSuccessful)
                                        {
                                            <span class="badge bg-success">موفق</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">ناموفق</span>
                                        }
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-info view-login-details" data-id="@login.Id">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center">هیچ سابقه ورودی یافت نشد</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="login-stats mt-4">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                            <div class="stat-content">
                                <h4 id="total-logins">@Model.Count()</h4>
                                <p>کل ورودها</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="stat-content">
                                <h4 id="successful-logins">@Model.Count(l => l.IsSuccessful)</h4>
                                <p>ورودهای موفق</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class="fas fa-times"></i>
                            </div>
                            <div class="stat-content">
                                <h4 id="failed-logins">@Model.Count(l => !l.IsSuccessful)</h4>
                                <p>ورودهای ناموفق</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <h4 id="last-login">
                                    @if (Model.Any())
                                    {
                                        var lastLogin = Model.OrderByDescending(l => l.LoginTime).FirstOrDefault();
                                        @lastLogin.LoginTime.ToString("yyyy/MM/dd")
                                    }
                                    else
                                    {
                                        <span>---</span>
                                    }
                                </h4>
                                <p>آخرین ورود</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginDetailsModal" tabindex="-1" role="dialog" aria-labelledby="loginDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginDetailsModalLabel">جزئیات ورود</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="login-details-content">
                    <!-- جزئیات ورود به صورت داینامیک اضافه می‌شوند -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // رویداد مشاهده جزئیات ورود
        document.querySelectorAll('.view-login-details').forEach(button => {
            button.addEventListener('click', function() {
                const loginId = this.getAttribute('data-id');

                fetch('/Profile/GetLoginDetails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ id: loginId })
                })
                .then(response => response.json())
                .then(data => {
                    // نمایش جزئیات ورود در مودال
                    document.getElementById('login-details-content').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <th width="40%">شناسه:</th>
                                        <td>${data.id}</td>
                                    </tr>
                                    <tr>
                                        <th>تاریخ و زمان:</th>
                                        <td>${new Date(data.loginTime).toLocaleString('fa-IR')}</td>
                                    </tr>
                                    <tr>
                                        <th>IP آدرس:</th>
                                        <td>${data.ipAddress}</td>
                                    </tr>
                                    <tr>
                                        <th>مرورگر:</th>
                                        <td>${data.browser}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <th width="40%">سیستم‌عامل:</th>
                                        <td>${data.operatingSystem}</td>
                                    </tr>
                                    <tr>
                                        <th>موقعیت جغرافیایی:</th>
                                        <td>${data.location || 'نامشخص'}</td>
                                    </tr>
                                    <tr>
                                        <th>وضعیت:</th>
                                        <td>
                                            ${data.isSuccess ?
                                                '<span class="badge bg-success">موفق</span>' :
                                                '<span class="badge bg-danger">ناموفق</span>'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>پیام:</th>
                                        <td>${data.message || '-'}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        ${data.userAgent ? `
                        <div class="mt-3">
                            <h6>User Agent:</h6>
                            <div class="bg-light p-2 rounded">
                                <code>${data.userAgent}</code>
                            </div>
                        </div>
                        ` : ''}
                    `;

                    // نمایش مودال
                    $('#loginDetailsModal').modal('show');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('خطا در دریافت جزئیات ورود');
                });
            });
        });

        // رویداد به‌روزرسانی تاریخچه
        document.getElementById('refresh-history').addEventListener('click', function() {
            // نمایش لودینگ
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال به‌روزرسانی...';
            this.disabled = true;

            // بارگذاری مجدد صفحه
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        });

        // رویداد خروجی تاریخچه
        document.getElementById('export-history').addEventListener('click', function() {
            // ایجاد فایل CSV از داده‌های جدول
            let csv = 'تاریخ و زمان,IP آدرس,مرورگر,سیستم‌عامل,موقعیت جغرافیایی,وضعیت\n';

            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const rowData = [
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent.trim()
                    ];
                    csv += rowData.join(',') + '\n';
                }
            });

            // دانلود فایل CSV
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'login_history.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
}