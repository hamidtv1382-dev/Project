@model AnalysisCallUser._03_EndPoint.Models.ViewModels.Analytics.NetworkAnalysisViewModel

@{
    ViewData["Title"] = "تحلیل شبکه ارتباطی";
}

<div class="network-analysis-container">
    <div class="page-header">
        <h3>تحلیل شبکه ارتباطی</h3>
        <div class="page-actions">
            <button id="fullscreen-toggle" class="btn btn-outline-secondary">
                <i class="fas fa-expand"></i> تمام صفحه
            </button>
            <button id="export-network" class="btn btn-success">
                <i class="fas fa-download"></i> خروجی
            </button>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-3">
            <div class="analysis-controls">
                <div class="control-header">
                    <h5>پارامترهای تحلیل</h5>
                </div>
                <div class="control-body">
                    <form id="network-analysis-form">
                        <div class="form-group">
                            <label for="phone-numbers">شماره‌های تلفن:</label>
                            <textarea id="phone-numbers" class="form-control" rows="4" placeholder="شماره‌های تلفن را وارد کنید (هر شماره در یک خط)">@string.Join("\n", Model.PhoneNumbers ?? new List<string>())</textarea>
                            <small class="form-text text-muted">حداکثر 10 شماره می‌توانید وارد کنید</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="max-depth">حداکثر عمق:</label>
                            @{
                                var maxDepthOptions = new List<SelectListItem>
                                                        {
                                                        new SelectListItem { Value = "1", Text = "1", Selected = Model.MaxDepth == 1 },
                                                        new SelectListItem { Value = "2", Text = "2", Selected = Model.MaxDepth == 2 },
                                                        new SelectListItem { Value = "3", Text = "3", Selected = Model.MaxDepth == 3 },
                                                        new SelectListItem { Value = "4", Text = "4", Selected = Model.MaxDepth == 4 },
                                                        new SelectListItem { Value = "5", Text = "5", Selected = Model.MaxDepth == 5 },
                                                        };
                            }

                            <select asp-for="MaxDepth" asp-items="maxDepthOptions" class="form-control"></select>

                            <small class="form-text text-muted">عمق تحلیل ارتباطات را مشخص می‌کند</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="min-connections">حداقل تعداد ارتباطات:</label>
                            <input type="number" id="min-connections" class="form-control" value="1" min="1" max="100" />
                            <small class="form-text text-muted">فایلتر کردن گره‌ها بر اساس تعداد ارتباطات</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="node-size">اندازه گره‌ها بر اساس:</label>
                            <select id="node-size" class="form-control">
                                <option value="connections">تعداد ارتباطات</option>
                                <option value="call-duration">مدت تماس</option>
                                <option value="call-frequency">فرکانس تماس</option>
                                <option value="fixed">ثابت</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="layout">چیدمان:</label>
                            <select id="layout" class="form-control">
                                <option value="physics">فیزیکی</option>
                                <option value="hierarchical">سلسله مراتبی</option>
                                <option value="circular">دایره‌ای</option>
                                <option value="random">تصادفی</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>فیلترها:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-incoming" checked>
                                <label class="form-check-label" for="show-incoming">
                                    نمایش تماس‌های ورودی
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-outgoing" checked>
                                <label class="form-check-label" for="show-outgoing">
                                    نمایش تماس‌های خروجی
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-missed">
                                <label class="form-check-label" for="show-missed">
                                    نمایش تماس‌های پاسخ داده نشده
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" id="analyze-network" class="btn btn-primary btn-block">
                                <i class="fas fa-project-diagram"></i> تحلیل شبکه
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="network-stats">
                <div class="stats-header">
                    <h5>آمار شبکه</h5>
                </div>
                <div class="stats-body">
                    <div class="stat-item">
                        <div class="stat-label">گره‌ها:</div>
                        <div class="stat-value" id="node-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">یال‌ها:</div>
                        <div class="stat-value" id="edge-count">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">چگالی:</div>
                        <div class="stat-value" id="network-density">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">میانگین درجه:</div>
                        <div class="stat-value" id="avg-degree">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="network-visualization">
                <div id="network-graph" class="network-graph"></div>
                <div class="network-controls-bottom">
                    <div class="btn-group" role="group">
                        <button type="button" id="zoom-in" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button type="button" id="zoom-out" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button type="button" id="zoom-fit" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-compress"></i>
                        </button>
                        <button type="button" id="toggle-physics" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-atom"></i>
                        </button>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color node-high"></div>
                            <span>گره پرارتباط</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color node-medium"></div>
                            <span>گره متوسط</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color node-low"></div>
                            <span>گره کم‌ارتباط</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="nodeDetailsModal" tabindex="-1" role="dialog" aria-labelledby="nodeDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="nodeDetailsModalLabel">جزئیات گره</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="node-details-content">
                    <!-- جزئیات گره به صورت داینامیک اضافه می‌شوند -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
                <button type="button" id="expand-node" class="btn btn-primary">گسترش شبکه</button>
                <button type="button" id="analyze-node" class="btn btn-info">تحلیل گره</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/vis-network/vis-network.min.js"></script>
    <script src="~/lib/html2canvas/html2canvas.min.js"></script>
    <script>
        let network;
        let nodes, edges;
        let selectedNodeId;
        
        // مقداردهی اولیه نمودار شبکه
        function initializeNetwork() {
            const container = document.getElementById('network-graph');
            
            // ایجاد داده‌های اولیه
            nodes = new vis.DataSet([]);
            edges = new vis.DataSet([]);
            
            // گزینه‌های نمودار
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 16,
                    font: {
                        size: 12,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: { inherit: 'from' },
                    smooth: {
                        type: 'continuous'
                    },
                    shadow: true
                },
                physics: {
                    stabilization: false,
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.3,
                        springLength: 95,
                        springConstant: 0.04,
                        damping: 0.09
                    }
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200,
                    navigationButtons: true,
                    keyboard: true
                }
            };
            
            // ایجاد نمودار
            network = new vis.Network(container, { nodes, edges }, options);
            
            // رویدادهای نمودار
            network.on('click', handleNodeClick);
            network.on('doubleClick', handleNodeDoubleClick);
            network.on('oncontext', handleNodeRightClick);
            
            updateNetworkStats();
        }
        
        // رویداد کلیک روی گره
        function handleNodeClick(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                showNodeDetails(nodeId);
            }
        }
        
        // رویداد دابل کلیک روی گره
        function handleNodeDoubleClick(params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                expandNetwork(nodeId);
            }
        }
        
        // رویداد کلیک راست روی گره
        function handleNodeRightClick(params) {
            params.event.preventDefault();
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                // نمایش منوی زمینه
                showContextMenu(nodeId, params.event);
            }
        }
        
        // نمایش جزئیات گره
        function showNodeDetails(nodeId) {
            selectedNodeId = nodeId;
            const node = nodes.get(nodeId);
            
            // محاسبه آمار گره
            const connectedNodes = network.getConnectedNodes(nodeId);
            const connectedEdges = network.getConnectedEdges(nodeId);
            
            document.getElementById('node-details-content').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">شناسه:</th>
                                <td>${node.id}</td>
                            </tr>
                            <tr>
                                <th>برچسب:</th>
                                <td>${node.label}</td>
                            </tr>
                            <tr>
                                <th>اندازه:</th>
                                <td>${node.size}</td>
                            </tr>
                            <tr>
                                <th>رنگ:</th>
                                <td><span style="display:inline-block;width:20px;height:20px;background-color:${node.color};"></span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">تعداد ارتباطات:</th>
                                <td>${connectedNodes.length}</td>
                            </tr>
                            <tr>
                                <th>درجه ورودی:</th>
                                <td>${getInDegree(nodeId)}</td>
                            </tr>
                            <tr>
                                <th>درجه خروجی:</th>
                                <td>${getOutDegree(nodeId)}</td>
                            </tr>
                            <tr>
                                <th>ضریب خوشگی:</th>
                                <td>${calculateClusteringCoefficient(nodeId).toFixed(3)}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>گره‌های متصل:</h6>
                        <div class="connected-nodes">
                            ${connectedNodes.map(id => {
                                const connectedNode = nodes.get(id);
                                return `<span class="badge bg-secondary mr-1">${connectedNode.label}</span>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            $('#nodeDetailsModal').modal('show');
        }
        
        // محاسبه درجه ورودی
        function getInDegree(nodeId) {
            const connectedEdges = network.getConnectedEdges(nodeId);
            return connectedEdges.filter(edgeId => {
                const edge = edges.get(edgeId);
                return edge.to === nodeId;
            }).length;
        }
        
        // محاسبه درجه خروجی
        function getOutDegree(nodeId) {
            const connectedEdges = network.getConnectedEdges(nodeId);
            return connectedEdges.filter(edgeId => {
                const edge = edges.get(edgeId);
                return edge.from === nodeId;
            }).length;
        }
        
        // محاسبه ضریب خوشگی
        function calculateClusteringCoefficient(nodeId) {
            const neighbors = network.getConnectedNodes(nodeId);
            if (neighbors.length < 2) return 0;
            
            let connections = 0;
            for (let i = 0; i < neighbors.length; i++) {
                for (let j = i + 1; j < neighbors.length; j++) {
                    if (network.isConnected(neighbors[i], neighbors[j])) {
                        connections++;
                    }
                }
            }
            
            return (2 * connections) / (neighbors.length * (neighbors.length - 1));
        }
        
        // گسترش شبکه
        function expandNetwork(nodeId) {
            const maxDepth = parseInt(document.getElementById('max-depth').value);
            const currentDepth = parseInt(document.getElementById('current-depth').value || '1');
            
            if (currentDepth >= maxDepth) {
                alert('حداکثر عمق تحلیل رسیده است');
                return;
            }
            
            // نمایش لودینگ
            document.getElementById('expand-node').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال گسترش...';
            document.getElementById('expand-node').disabled = true;
            
            // ارسال درخواست به سرور
            fetch('/Analytics/ExpandNetworkGraph', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    nodeId: nodeId,
                    maxDepth: maxDepth,
                    currentDepth: currentDepth
                })
            })
            .then(response => response.json())
            .then(data => {
                // افزودن گره‌ها و یال‌های جدید
                nodes.add(data.nodes);
                edges.add(data.edges);
                
                // به‌روزرسانی آمار شبکه
                updateNetworkStats();
                
                // به‌روزرسانی عمق فعلی
                document.getElementById('current-depth').value = currentDepth + 1;
                
                // بستن مودال
                $('#nodeDetailsModal').modal('hide');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در گسترش شبکه');
            })
            .finally(() => {
                // بازگرداندن دکمه به حالت اولیه
                document.getElementById('expand-node').innerHTML = 'گسترش شبکه';
                document.getElementById('expand-node').disabled = false;
            });
        }
        
        // تحلیل شبکه
        document.getElementById('analyze-network').addEventListener('click', function() {
            const phoneNumbers = document.getElementById('phone-numbers').value
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            const maxDepth = parseInt(document.getElementById('max-depth').value);
            const minConnections = parseInt(document.getElementById('min-connections').value);
            const nodeSize = document.getElementById('node-size').value;
            const layout = document.getElementById('layout').value;
            
            const showIncoming = document.getElementById('show-incoming').checked;
            const showOutgoing = document.getElementById('show-outgoing').checked;
            const showMissed = document.getElementById('show-missed').checked;
            
            if (phoneNumbers.length === 0) {
                alert('حداقل یک شماره تلفن وارد کنید');
                return;
            }
            
            // نمایش لودینگ
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال تحلیل...';
            this.disabled = true;
            
            // ارسال درخواست به سرور
            fetch('/Analytics/AnalyzeNetwork', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    phoneNumbers: phoneNumbers,
                    maxDepth: maxDepth,
                    minConnections: minConnections,
                    nodeSize: nodeSize,
                    layout: layout,
                    showIncoming: showIncoming,
                    showOutgoing: showOutgoing,
                    showMissed: showMissed
                })
            })
            .then(response => response.json())
            .then(data => {
                // به‌روزرسانی گره‌ها و یال‌ها
                nodes.clear();
                edges.clear();
                nodes.add(data.nodes);
                edges.add(data.edges);
                
                // به‌روزرسانی گزینه‌های نمودار
                updateNetworkOptions(layout);
                
                // به‌روزرسانی آمار شبکه
                updateNetworkStats();
                
                // ذخیره عمق فعلی
                document.getElementById('current-depth').value = '1';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در تحلیل شبکه');
            })
            .finally(() => {
                // بازگرداندن دکمه به حالت اولیه
                this.innerHTML = '<i class="fas fa-project-diagram"></i> تحلیل شبکه';
                this.disabled = false;
            });
        });
        
        // به‌روزرسانی گزینه‌های نمودار
        function updateNetworkOptions(layout) {
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 16,
                    font: {
                        size: 12,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: { inherit: 'from' },
                    smooth: {
                        type: 'continuous'
                    },
                    shadow: true
                }
            };
            
            if (layout === 'hierarchical') {
                options.layout = {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed'
                    }
                };
                options.physics = false;
            } else if (layout === 'circular') {
                options.layout = {
                    randomSeed: 2
                };
                options.physics = {
                    stabilization: {
                        iterations: 300
                    }
                };
            } else if (layout === 'random') {
                options.layout = {
                    randomSeed: Math.floor(Math.random() * 1000)
                };
                options.physics = {
                    stabilization: {
                        iterations: 100
                    }
                };
            } else {
                options.physics = {
                    stabilization: false,
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.3,
                        springLength: 95,
                        springConstant: 0.04,
                        damping: 0.09
                    }
                };
            }
            
            network.setOptions(options);
        }
        
        // به‌روزرسانی آمار شبکه
        function updateNetworkStats() {
            const nodeCount = nodes.length;
            const edgeCount = edges.length;
            
            document.getElementById('node-count').textContent = nodeCount;
            document.getElementById('edge-count').textContent = edgeCount;
            
            if (nodeCount > 1) {
                const maxEdges = nodeCount * (nodeCount - 1) / 2;
                const density = (edgeCount / maxEdges * 100).toFixed(1);
                document.getElementById('network-density').textContent = density + '%';
                
                const avgDegree = (2 * edgeCount / nodeCount).toFixed(2);
                document.getElementById('avg-degree').textContent = avgDegree;
            } else {
                document.getElementById('network-density').textContent = '0%';
                document.getElementById('avg-degree').textContent = '0';
            }
        }
        
        // کنترل‌های زوم
        document.getElementById('zoom-in').addEventListener('click', function() {
            const scale = network.getScale();
            network.moveTo({ scale: scale * 1.2 });
        });
        
        document.getElementById('zoom-out').addEventListener('click', function() {
            const scale = network.getScale();
            network.moveTo({ scale: scale * 0.8 });
        });
        
        document.getElementById('zoom-fit').addEventListener('click', function() {
            network.fit();
        });
        
        document.getElementById('toggle-physics').addEventListener('click', function() {
            const physicsEnabled = network.physics.physicsEnabled;
            network.setOptions({ physics: { enabled: !physicsEnabled } });
            
            if (physicsEnabled) {
                this.classList.add('active');
            } else {
                this.classList.remove('active');
            }
        });
        
        // خروجی شبکه
        document.getElementById('export-network').addEventListener('click', function() {
            html2canvas(document.getElementById('network-graph')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'network-analysis.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });
        
        // تمام صفحه
        document.getElementById('fullscreen-toggle').addEventListener('click', function() {
            const elem = document.getElementById('network-graph');
            
            if (!document.fullscreenElement) {
                elem.requestFullscreen().then(() => {
                    this.innerHTML = '<i class="fas fa-compress"></i> خروج از تمام صفحه';
                    setTimeout(() => {
                        network.redraw();
                        network.fit();
                    }, 500);
                }).catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen().then(() => {
                    this.innerHTML = '<i class="fas fa-expand"></i> تمام صفحه';
                    setTimeout(() => {
                        network.redraw();
                        network.fit();
                    }, 500);
                });
            }
        });
        
        // تحلیل گره
        document.getElementById('analyze-node').addEventListener('click', function() {
            if (selectedNodeId) {
                // انتقال به صفحه تحلیل گره
                window.location.href = '/Analytics/NodeAnalysis?id=' + selectedNodeId;
            }
        });
        
        // مقداردهی اولیه
        document.addEventListener('DOMContentLoaded', function() {
            initializeNetwork();
            
             // اگر داده‌های اولیه وجود دارد، نمایش دهید
             const initialNodes = @Html.Raw(Json.Serialize(Model.NetworkGraph?.Nodes ?? new List<AnalysisCallUser._03_EndPoint.Models.ViewModels.Dashboard.Node>()));
             const initialEdges = @Html.Raw(Json.Serialize(Model.NetworkGraph?.Edges ?? new List<AnalysisCallUser._03_EndPoint.Models.ViewModels.Dashboard.Edge>()));

            
            if (initialNodes.length > 0) {
                nodes.add(initialNodes);
                edges.add(initialEdges);
                updateNetworkStats();
                network.fit();
            }
        });
    </script>
}