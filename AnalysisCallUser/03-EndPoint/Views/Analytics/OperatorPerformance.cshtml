@model AnalysisCallUser._03_EndPoint.Models.ViewModels.Analytics.OperatorPerformanceViewModel

@{
    ViewData["Title"] = "عملکرد اپراتورها";
}

<div class="operator-performance-container">
    <div class="page-header">
        <h3>عملکرد اپراتورها</h3>
        <div class="page-actions">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" data-view="overview">نمای کلی</button>
                <button type="button" class="btn btn-outline-secondary" data-view="detailed">جزئیات</button>
                <button type="button" class="btn btn-outline-secondary" data-view="comparison">مقایسه</button>
            </div>
            <button id="refresh-performance" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt"></i> به‌روزرسانی
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="performance-filters">
                <div class="filter-header">
                    <h5>فیلترها</h5>
                </div>
                <div class="filter-body">
                    <form id="operator-filter-form">
                        <div class="form-group">
                            <label for="date-range">بازه زمانی:</label>
                            <div class="input-group">
                                <input type="date" id="start-date" class="form-control" />
                                <span class="input-group-text">تا</span>
                                <input type="date" id="end-date" class="form-control" />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="operator-select">اپراتورها:</label>
                            <select id="operator-select" class="form-control" multiple>
                                @foreach (var op in ViewBag.Operators)
                                {
                                    <option value="@op.OperatorID">@op.OperatorName</option>
                                }
                            </select>
                            <small class="form-text text-muted">برای انتخاب چند اپراتور، کلید Ctrl را نگه دارید</small>
                        </div>

                        <div class="form-group">
                            <label for="metric-select">معیار ارزیابی:</label>
                            <select id="metric-select" class="form-control">
                                <option value="call-volume">حجم تماس</option>
                                <option value="answer-rate">نرخ پاسخگویی</option>
                                <option value="avg-duration">میانگین مدت تماس</option>
                                <option value="revenue">درآمد</option>
                                <option value="customer-satisfaction">رضایت مشتری</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>نمایش:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-trend" checked>
                                <label class="form-check-label" for="show-trend">
                                    نمایش روند
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-benchmark">
                                <label class="form-check-label" for="show-benchmark">
                                    نمایش معیار ارزیابی
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="show-ranking" checked>
                                <label class="form-check-label" for="show-ranking">
                                    نمایش رتبه‌بندی
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="button" id="apply-filters" class="btn btn-primary btn-block">
                                <i class="fas fa-filter"></i> اعمال فیلترها
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="performance-summary">
                <div class="summary-header">
                    <h5>خلاصه عملکرد</h5>
                </div>
                <div class="summary-body">
                    <div class="summary-item">
                        <div class="summary-label">میانگین نرخ پاسخگویی:</div>
                        <div class="summary-value" id="avg-answer-rate">---</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">میانگین مدت تماس:</div>
                        <div class="summary-value" id="avg-duration">---</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">کل تماس‌ها:</div>
                        <div class="summary-value" id="total-calls">---</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">بهترین اپراتور:</div>
                        <div class="summary-value" id="top-operator">---</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="performance-content">
                <!-- نمای کلی -->
                <div id="overview-view" class="view-content active">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5>نمودار عملکرد اپراتورها</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="operator-performance-chart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>نرخ پاسخگویی</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="answer-rate-chart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>میانگین مدت تماس</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="duration-chart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- نمای جزئیات -->
                <div id="detailed-view" class="view-content">
                    <div class="card">
                        <div class="card-header">
                            <h5>جدول عملکرد اپراتورها</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>اپراتور</th>
                                            <th>کل تماس‌ها</th>
                                            <th>پاسخ داده شده</th>
                                            <th>نرخ پاسخگویی</th>
                                            <th>میانگین مدت</th>
                                            <th>درآمد</th>
                                            <th>رتبه</th>
                                            <th>عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="operator-performance-tbody">
                                        <!-- داده‌ها به صورت داینامیک اضافه می‌شوند -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- نمای مقایسه -->
                <div id="comparison-view" class="view-content">
                    <div class="card">
                        <div class="card-header">
                            <h5>مقایسه اپراتورها</h5>
                        </div>
                        <div class="card-body">
                            <div class="comparison-chart-container">
                                <canvas id="comparison-chart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="operatorDetailsModal" tabindex="-1" role="dialog" aria-labelledby="operatorDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="operatorDetailsModalLabel">جزئیات اپراتور</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="operator-details-content">
                    <!-- جزئیات اپراتور به صورت داینامیک اضافه می‌شوند -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
                <button type="button" id="analyze-operator" class="btn btn-primary">تحلیل اپراتور</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/chartjs/dist/chart.min.js"></script>
    <script>
        let operatorPerformanceChart, answerRateChart, durationChart, comparisonChart;
        let currentView = 'overview';
        let performanceData = [];

        // مقداردهی اولیه نمودارها
        function initializeCharts() {
            // نمودار عملکرد اپراتورها
            const performanceCtx = document.getElementById('operator-performance-chart').getContext('2d');
            operatorPerformanceChart = new Chart(performanceCtx, {
                type: 'radar',
                data: {
                    labels: ['حجم تماس', 'نرخ پاسخگویی', 'کیفیت', 'سرعت', 'رضایت مشتری', 'درآمد'],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // نمودار نرخ پاسخگویی
            const answerRateCtx = document.getElementById('answer-rate-chart').getContext('2d');
            answerRateChart = new Chart(answerRateCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'نرخ پاسخگویی (%)',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // نمودار میانگین مدت تماس
            const durationCtx = document.getElementById('duration-chart').getContext('2d');
            durationChart = new Chart(durationCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'میانگین مدت تماس (ثانیه)',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // نمودار مقایسه
            const comparisonCtx = document.getElementById('comparison-chart').getContext('2d');
            comparisonChart = new Chart(comparisonCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            loadPerformanceData();
        }

        // بارگذاری داده‌های عملکرد
        function loadPerformanceData() {
            fetch('/Analytics/GetOperatorPerformance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                performanceData = data;
                updateCharts(data);
                updateTable(data);
                updateSummary(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در بارگذاری داده‌های عملکرد');
            });
        }

        // به‌روزرسانی نمودارها
        function updateCharts(data) {
            // به‌روزرسانی نمودار رادار
            const radarDatasets = data.slice(0, 5).map(operator => ({
                label: operator.name,
                data: [
                    operator.totalCalls / 100,
                    operator.answerRate,
                    operator.quality,
                    operator.speed,
                    operator.customerSatisfaction,
                    operator.revenue / 1000
                ],
                backgroundColor: getRandomColor(0.2),
                borderColor: getRandomColor(1),
                borderWidth: 1
            }));

            operatorPerformanceChart.data.datasets = radarDatasets;
            operatorPerformanceChart.update();

            // به‌روزرسانی نمودار نرخ پاسخگویی
            answerRateChart.data.labels = data.map(op => op.name);
            answerRateChart.data.datasets[0].data = data.map(op => op.answerRate);
            answerRateChart.update();

            // به‌روزرسانی نمودار مدت تماس
            durationChart.data.labels = data.map(op => op.name);
            durationChart.data.datasets[0].data = data.map(op => op.avgDuration);
            durationChart.update();
        }

        // به‌روزرسانی جدول
        function updateTable(data) {
            const tbody = document.getElementById('operator-performance-tbody');
            tbody.innerHTML = '';

            // مرتب‌سازی بر اساس رتبه
            const sortedData = [...data].sort((a, b) => a.rank - b.rank);

            sortedData.forEach(operator => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${operator.name}</td>
                    <td>${operator.totalCalls.toLocaleString()}</td>
                    <td>${operator.answeredCalls.toLocaleString()}</td>
                    <td>${operator.answerRate.toFixed(1)}%</td>
                    <td>${operator.avgDuration.toFixed(1)} ثانیه</td>
                    <td>${operator.revenue.toLocaleString()} ریال</td>
                    <td>
                        <span class="badge bg-${getRankBadgeClass(operator.rank)}">${operator.rank}</span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-info view-operator-details" data-id="${operator.id}">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // افزودن رویداد مشاهده جزئیات
            document.querySelectorAll('.view-operator-details').forEach(button => {
                button.addEventListener('click', function() {
                    const operatorId = this.getAttribute('data-id');
                    showOperatorDetails(operatorId);
                });
            });
        }

        // به‌روزرسانی خلاصه عملکرد
        function updateSummary(data) {
            if (data.length === 0) return;

            const avgAnswerRate = data.reduce((sum, op) => sum + op.answerRate, 0) / data.length;
            const avgDuration = data.reduce((sum, op) => sum + op.avgDuration, 0) / data.length;
            const totalCalls = data.reduce((sum, op) => sum + op.totalCalls, 0);
            const topOperator = data.reduce((best, op) => op.rank < best.rank ? op : best, data[0]);

            document.getElementById('avg-answer-rate').textContent = avgAnswerRate.toFixed(1) + '%';
            document.getElementById('avg-duration').textContent = avgDuration.toFixed(1) + ' ثانیه';
            document.getElementById('total-calls').textContent = totalCalls.toLocaleString();
            document.getElementById('top-operator').textContent = topOperator.name;
        }

        // نمایش جزئیات اپراتور
        function showOperatorDetails(operatorId) {
            const operator = performanceData.find(op => op.id == operatorId);

            if (!operator) return;

            document.getElementById('operator-details-content').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">نام اپراتور:</th>
                                <td>${operator.name}</td>
                            </tr>
                            <tr>
                                <th>شناسه:</th>
                                <td>${operator.id}</td>
                            </tr>
                            <tr>
                                <th>کل تماس‌ها:</th>
                                <td>${operator.totalCalls.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <th>پاسخ داده شده:</th>
                                <td>${operator.answeredCalls.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <th>نرخ پاسخگویی:</th>
                                <td>${operator.answerRate.toFixed(1)}%</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">میانگین مدت تماس:</th>
                                <td>${operator.avgDuration.toFixed(1)} ثانیه</td>
                            </tr>
                            <tr>
                                <th>کیفیت:</th>
                                <td>${operator.quality.toFixed(1)}/100</td>
                            </tr>
                            <tr>
                                <th>سرعت:</th>
                                <td>${operator.speed.toFixed(1)}/100</td>
                            </tr>
                            <tr>
                                <th>رضایت مشتری:</th>
                                <td>${operator.customerSatisfaction.toFixed(1)}/100</td>
                            </tr>
                            <tr>
                                <th>درآمد:</th>
                                <td>${operator.revenue.toLocaleString()} ریال</td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>روند عملکرد:</h6>
                        <canvas id="operator-trend-chart" width="400" height="150"></canvas>
                    </div>
                </div>
            `;

            $('#operatorDetailsModal').modal('show');

            // ایجاد نمودار روند عملکرد
            setTimeout(() => {
                const trendCtx = document.getElementById('operator-trend-chart').getContext('2d');
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: ['هفته 1', 'هفته 2', 'هفته 3', 'هفته 4'],
                        datasets: [{
                            label: 'نرخ پاسخگویی',
                            data: [85, 87, 86, operator.answerRate],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }, 100);
        }

        // تابع برای گرفتن رنگ تصادفی
        function getRandomColor(alpha) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // تابع برای گرفتن کلاس بر اساس رتبه
        function getRankBadgeClass(rank) {
            if (rank === 1) return 'success';
            if (rank === 2) return 'info';
            if (rank === 3) return 'warning';
            return 'secondary';
        }

        // رویداد تغییر نما
        document.querySelectorAll('[data-view]').forEach(button => {
            button.addEventListener('click', function() {
                // حذف کلاس active از همه دکمه‌ها
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.classList.remove('active');
                });

                // افزودن کلاس active به دکمه فعلی
                this.classList.add('active');

                // به‌روزرسانی نمای فعلی
                currentView = this.getAttribute('data-view');

                // نمایش محتوای مربوطه
                document.querySelectorAll('.view-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(currentView + '-view').classList.add('active');

                // اگر نمای مقایسه است، به‌روزرسانی نمودار مقایسه
                if (currentView === 'comparison') {
                    updateComparisonChart();
                }
            });
        });

        // به‌روزرسانی نمودار مقایسه
        function updateComparisonChart() {
            const selectedOperators = Array.from(document.getElementById('operator-select').selectedOptions)
                .map(option => option.value);

            if (selectedOperators.length === 0) return;

            const selectedData = performanceData.filter(op => selectedOperators.includes(op.id.toString()));

            const comparisonDatasets = selectedData.map(operator => ({
                label: operator.name,
                data: [operator.totalCalls / 100, operator.answerRate, operator.avgDuration, operator.quality],
                borderColor: getRandomColor(1),
                backgroundColor: getRandomColor(0.2),
                tension: 0.4,
                fill: false
            }));

            comparisonChart.data.labels = ['حجم تماس', 'نرخ پاسخگویی', 'مدت تماس', 'کیفیت'];
            comparisonChart.data.datasets = comparisonDatasets;
            comparisonChart.update();
        }

        // رویداد اعمال فیلترها
        document.getElementById('apply-filters').addEventListener('click', function() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const selectedOperators = Array.from(document.getElementById('operator-select').selectedOptions)
                .map(option => option.value);
            const metric = document.getElementById('metric-select').value;

            // نمایش لودینگ
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال اعمال فیلترها...';
            this.disabled = true;

            // ارسال درخواست به سرور
            fetch('/Analytics/UpdateOperatorPerformance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: JSON.stringify({
                    startDate: startDate,
                    endDate: endDate,
                    operatorIds: selectedOperators,
                    metric: metric
                })
            })
            .then(response => response.json())
            .then(data => {
                performanceData = data;
                updateCharts(data);
                updateTable(data);
                updateSummary(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('خطا در اعمال فیلترها');
            })
            .finally(() => {
                // بازگرداندن دکمه به حالت اولیه
                this.innerHTML = '<i class="fas fa-filter"></i> اعمال فیلترها';
                this.disabled = false;
            });
        });

        // رویداد به‌روزرسانی عملکرد
        document.getElementById('refresh-performance').addEventListener('click', function() {
            // نمایش لودینگ
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> در حال به‌روزرسانی...';
            this.disabled = true;

            // بارگذاری مجدد داده‌ها
            loadPerformanceData();

            setTimeout(() => {
                // بازگرداندن دکمه به حالت اولیه
                this.innerHTML = '<i class="fas fa-sync-alt"></i> به‌روزرسانی';
                this.disabled = false;
            }, 1000);
        });

        // تحلیل اپراتور
        document.getElementById('analyze-operator').addEventListener('click', function() {
            // انتقال به صفحه تحلیل اپراتور
            window.location.href = '/Analytics/OperatorAnalysis';
        });

        // مقداردهی اولیه
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });
    </script>
}