@using AnalysisCallUser._03_EndPoint.Models.ViewModels.Dashboard
@model AnalysisCallUser._03_EndPoint.Models.ViewModels.Analytics.GeographicAnalysisViewModel

@{
    ViewData["Title"] = "تحلیل جغرافیایی";
}

<div class="geographic-analysis-container">
    <div class="page-header">
        <h3>تحلیل جغرافیایی</h3>
        <div class="page-actions">
            <button id="fullscreen-toggle" class="btn btn-outline-secondary">
                <i class="fas fa-expand"></i> تمام صفحه
            </button>
            <button id="export-map" class="btn btn-success">
                <i class="fas fa-download"></i> خروجی نقشه
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="analysis-controls">
                <div class="control-header">
                    <h5>فیلترهای جغرافیایی</h5>
                </div>
                <div class="control-body">
                    <form id="geographic-filter-form" asp-action="GeographicAnalysis" method="post">
                        <div class="form-group">
                            <label for="country-ids">کشورها:</label>
                            <select id="country-ids" name="CountryIds" class="form-control" multiple>
                                @* این بخش باید با لیست کشورهای موجود پر شود *@
                                <option value="1">ایران</option>
                                <option value="2">ترکیه</option>
                                <option value="3">آلمان</option>
                                <option value="4">فرانسه</option>
                                <option value="5">چین</option>
                            </select>
                            <small class="form-text text-muted">برای انتخاب چند کشور، کلید Ctrl را نگه دارید.</small>
                        </div>

                        <div class="form-group">
                            <label for="visualization-type">نوع نمایش:</label>
                            <select id="visualization-type" class="form-control">
                                <option value="bubble">نقشه حبابی</option>
                                <option value="heat">نقشه حرارتی</option>
                                <option value="choropleth">نقشه رنگی</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-filter"></i> اعمال فیلترها
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="region-stats">
                <div class="stats-header">
                    <h5>آمار مناطق</h5>
                </div>
                <div class="stats-body">
                    <div class="stat-item">
                        <div class="stat-label">کشورهای فعال:</div>
                        <div class="stat-value" id="active-countries">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">شهرهای فعال:</div>
                        <div class="stat-value" id="active-cities">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">پرتماس‌ترین کشور:</div>
                        <div class="stat-value" id="top-country">---</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">پرتماس‌ترین شهر:</div>
                        <div class="stat-value" id="top-city">---</div>
                    </div>
                </div>
            </div>

            <div class="top-regions">
                <div class="top-regions-header">
                    <h5>برترین مناطق</h5>
                </div>
                <div class="top-regions-body">
                    <div id="top-countries-list">
                        <!-- لیست برترین کشورها به صورت داینامیک اضافه می‌شود -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="map-visualization">
                <div id="world-map" class="world-map"></div>
                <div class="map-controls">
                    <div class="btn-group" role="group">
                        <button type="button" id="zoom-in" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button type="button" id="zoom-out" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button type="button" id="reset-map" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                    <div class="legend">
                        <div class="legend-title">تعداد تماس‌ها</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #ffeda0;"></div>
                                <span>0 - 100</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #fed976;"></div>
                                <span>100 - 500</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #feb24c;"></div>
                                <span>500 - 1000</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #fd8d3c;"></div>
                                <span>1000 - 5000</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #fc4e2a;"></div>
                                <span>5000 - 10000</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #e31a1c;"></div>
                                <span>10000 - 50000</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #b10026;"></div>
                                <span>50000+</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>تحلیل‌های جغرافیایی پیشرفته</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="chart-container">
                                <h6>تماس‌ها بر اساس قاره</h6>
                                <canvas id="continent-chart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="chart-container">
                                <h6>تماس‌های بین‌المللی در مقابل داخلی</h6>
                                <canvas id="domestic-intl-chart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="chart-container">
                                <h6>مسافت‌های تماس</h6>
                                <canvas id="distance-chart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="regionDetailsModal" tabindex="-1" role="dialog" aria-labelledby="regionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regionDetailsModalLabel">جزئیات منطقه</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="region-details-content">
                    <!-- جزئیات منطقه به صورت داینامیک اضافه می‌شوند -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="~/lib/leaflet/dist/leaflet.css" />
    <script src="~/lib/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="~/lib/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="~/lib/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="~/lib/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="~/lib/chartjs/dist/chart.min.js"></script>
    <script src="~/lib/html2canvas/html2canvas.min.js"></script>
    <script>
        let map;
        let currentLayer;
        let continentChart, domesticIntlChart, distanceChart;

        // مقداردهی اولیه نقشه
        function initializeMap() {
            map = L.map('world-map').setView([30, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // افزودن داده‌های اولیه
            loadInitialData();
        }

        // بارگذاری داده‌های اولیه
        function loadInitialData() {
            const mapData = @Html.Raw(Json.Serialize(Model.MapData?.Points ?? new List<MapViewModel.MapPoint>()));

            if (mapData.length > 0) {
                showBubbleMap(mapData);
                updateRegionStats(mapData);
                updateTopRegions(mapData);
            }

            // مقداردهی اولیه نمودارها
            initializeCharts();
        }

        // تابع برای تعیین رنگ بر اساس تعداد تماس‌ها
        function getColor(callCount) {
            return callCount > 50000 ? '#b10026' :
                   callCount > 10000 ? '#e31a1c' :
                   callCount > 5000 ? '#fc4e2a' :
                   callCount > 1000 ? '#fd8d3c' :
                   callCount > 500 ? '#feb24c' :
                   callCount > 100 ? '#fed976' :
                   '#ffeda0';
        }

        // تابع برای تعیین شعاع بر اساس تعداد تماس‌ها
        function getRadius(callCount) {
            return Math.sqrt(callCount) * 1000;
        }

        // نمایش نقشه حبابی
        function showBubbleMap(data) {
            // حذف لایه فعلی
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // ایجاد لایه جدید
            currentLayer = L.layerGroup();

            // افزودن نقاط به نقشه
            data.forEach(point => {
                // استفاده از یک سرویس برای تبدیل نام کشور و شهر به مختصات
                // در اینجا از مختصات‌های نمونه استفاده شده است
                const lat = getLatForCity(point.CountryName, point.CityName);
                const lng = getLngForCity(point.CountryName, point.CityName);

                L.circle([lat, lng], {
                    color: getColor(point.CallCount),
                    fillColor: getColor(point.CallCount),
                    fillOpacity: 0.7,
                    radius: getRadius(point.CallCount)
                }).addTo(currentLayer)
                .bindPopup(`<strong>${point.CountryName}, ${point.CityName}</strong><br>
                           تعداد تماس‌ها: ${point.CallCount.toLocaleString()}<br>
                           میانگین مدت تماس: ${point.AvgDuration ? point.AvgDuration.toFixed(1) + ' ثانیه' : '---'}<br>
                           نرخ پاسخگویی: ${point.AnswerRate ? (point.AnswerRate * 100).toFixed(1) + '%' : '---'}`)
                .on('click', function() {
                    showRegionDetails(point, lat, lng);
                });
            });

            // افزودن لایه به نقشه
            currentLayer.addTo(map);
        }

        // نمایش نقشه حرارتی
        function showHeatMap(data) {
            // حذف لایه فعلی
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // تبدیل داده‌ها به فرمت مناسب برای نقشه حرارتی
            const heatData = data.map(point => {
                const lat = getLatForCity(point.CountryName, point.CityName);
                const lng = getLngForCity(point.CountryName, point.CityName);
                return [lat, lng, point.CallCount];
            });

            // ایجاد لایه جدید
            currentLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                max: Math.max(...data.map(point => point.CallCount))
            });

            // افزودن لایه به نقشه
            currentLayer.addTo(map);
        }

        // نمایش نقشه رنگی
        function showChoroplethMap(data) {
            // حذف لایه فعلی
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // ایجاد لایه جدید
            currentLayer = L.layerGroup();

            // افزودن نقاط به نقشه
            data.forEach(point => {
                const lat = getLatForCity(point.CountryName, point.CityName);
                const lng = getLngForCity(point.CountryName, point.CityName);

                L.circleMarker([lat, lng], {
                    radius: 10,
                    fillColor: getColor(point.CallCount),
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(currentLayer)
                .bindPopup(`<strong>${point.CountryName}, ${point.CityName}</strong><br>
                           تعداد تماس‌ها: ${point.CallCount.toLocaleString()}<br>
                           میانگین مدت تماس: ${point.AvgDuration ? point.AvgDuration.toFixed(1) + ' ثانیه' : '---'}<br>
                           نرخ پاسخگویی: ${point.AnswerRate ? (point.AnswerRate * 100).toFixed(1) + '%' : '---'}`)
                .on('click', function() {
                    showRegionDetails(point, lat, lng);
                });
            });

            // افزودن لایه به نقشه
            currentLayer.addTo(map);
        }

        // تابع برای دریافت عرض جغرافیایی یک شهر
        function getLatForCity(countryName, cityName) {
            // در یک پیاده‌سازی واقعی، این تابع باید از یک API یا پایگاه داده استفاده کند
            // در اینجا از مقادیر نمونه استفاده شده است
            const cityCoords = {
                "تهران، ایران": [35.6961, 51.4231],
                "استانبول، ترکیه": [41.0082, 28.9784],
                "برلین، آلمان": [52.5200, 13.4050],
                "پاریس، فرانسه": [48.8566, 2.3522],
                "پکن، چین": [39.9042, 116.4074],
                "نیویورک، آمریکا": [40.7128, -74.0060],
                "لندن، بریتانیا": [51.5074, -0.1278],
                "توکیو، ژاپن": [35.6762, 139.6503],
                "سیدنی، استرالیا": [-33.8688, 151.2093],
                "ریو دو ژانیرو، برزیل": [-22.9068, -43.1729]
            };

            const key = `${cityName}، ${countryName}`;
            if (cityCoords[key]) {
                return cityCoords[key][0];
            }

            // اگر شهر در لیست نبود، از مختصات کشور استفاده کن
            const countryCoords = {
                "ایران": [32.4279, 53.6880],
                "ترکیه": [38.9637, 35.2433],
                "آلمان": [51.1657, 10.4515],
                "فرانسه": [46.2276, 2.2137],
                "چین": [35.8617, 104.1954],
                "آمریکا": [37.0902, -95.7129],
                "بریتانیا": [55.3781, -3.4360],
                "ژاپن": [36.2048, 138.2529],
                "استرالیا": [-25.2744, 133.7751],
                "برزیل": [-14.2350, -51.9253]
            };

            return countryCoords[countryName] ? countryCoords[countryName][0] : 0;
        }

        // تابع برای دریافت طول جغرافیایی یک شهر
        function getLngForCity(countryName, cityName) {
            // در یک پیاده‌سازی واقعی، این تابع باید از یک API یا پایگاه داده استفاده کند
            // در اینجا از مقادیر نمونه استفاده شده است
            const cityCoords = {
                "تهران، ایران": [35.6961, 51.4231],
                "استانبول، ترکیه": [41.0082, 28.9784],
                "برلین، آلمان": [52.5200, 13.4050],
                "پاریس، فرانسه": [48.8566, 2.3522],
                "پکن، چین": [39.9042, 116.4074],
                "نیویورک، آمریکا": [40.7128, -74.0060],
                "لندن، بریتانیا": [51.5074, -0.1278],
                "توکیو، ژاپن": [35.6762, 139.6503],
                "سیدنی، استرالیا": [-33.8688, 151.2093],
                "ریو دو ژانیرو، برزیل": [-22.9068, -43.1729]
            };

            const key = `${cityName}، ${countryName}`;
            if (cityCoords[key]) {
                return cityCoords[key][1];
            }

            // اگر شهر در لیست نبود، از مختصات کشور استفاده کن
            const countryCoords = {
                "ایران": [32.4279, 53.6880],
                "ترکیه": [38.9637, 35.2433],
                "آلمان": [51.1657, 10.4515],
                "فرانسه": [46.2276, 2.2137],
                "چین": [35.8617, 104.1954],
                "آمریکا": [37.0902, -95.7129],
                "بریتانیا": [55.3781, -3.4360],
                "ژاپن": [36.2048, 138.2529],
                "استرالیا": [-25.2744, 133.7751],
                "برزیل": [-14.2350, -51.9253]
            };

            return countryCoords[countryName] ? countryCoords[countryName][1] : 0;
        }

        // به‌روزرسانی آمار مناطق
        function updateRegionStats(data) {
            const countries = new Set(data.map(point => point.CountryName));
            const cities = new Set(data.map(point => point.CityName));

            document.getElementById('active-countries').textContent = countries.size;
            document.getElementById('active-cities').textContent = cities.size;

            // پیدا کردن پرتماس‌ترین کشور
            const topCountry = data.reduce((max, point) => point.CallCount > max.CallCount ? point : max, data[0]);
            document.getElementById('top-country').textContent = topCountry ? topCountry.CountryName : '---';

            // پیدا کردن پرتماس‌ترین شهر
            const topCity = data.reduce((max, point) => point.CallCount > max.CallCount ? point : max, data[0]);
            document.getElementById('top-city').textContent = topCity ? topCity.CityName : '---';
        }

        // به‌روزرسانی برترین مناطق
        function updateTopRegions(data) {
            // مرتب‌سازی کشورها بر اساس تعداد تماس‌ها
            const sortedCountries = data
                .filter((point, index, self) =>
                    index === self.findIndex(p => p.CountryName === point.CountryName))
                .sort((a, b) => b.CallCount - a.CallCount)
                .slice(0, 5);

            const topCountriesList = document.getElementById('top-countries-list');
            topCountriesList.innerHTML = '';

            sortedCountries.forEach((country, index) => {
                const item = document.createElement('div');
                item.className = 'top-region-item';
                item.innerHTML = `
                    <div class="rank">${index + 1}</div>
                    <div class="info">
                        <div class="name">${country.CountryName}</div>
                        <div class="count">${country.CallCount.toLocaleString()} تماس</div>
                    </div>
                `;
                topCountriesList.appendChild(item);
            });
        }

        // نمایش جزئیات منطقه
        function showRegionDetails(region, lat, lng) {
            document.getElementById('region-details-content').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">کشور:</th>
                                <td>${region.CountryName}</td>
                            </tr>
                            <tr>
                                <th>شهر:</th>
                                <td>${region.CityName}</td>
                            </tr>
                            <tr>
                                <th>مختصات:</th>
                                <td>${lat.toFixed(4)}, ${lng.toFixed(4)}</td>
                            </tr>
                            <tr>
                                <th>تعداد تماس‌ها:</th>
                                <td>${region.CallCount.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">میانگین مدت تماس:</th>
                                <td>${region.AvgDuration ? region.AvgDuration.toFixed(1) + ' ثانیه' : '---'}</td>
                            </tr>
                            <tr>
                                <th>نرخ پاسخگویی:</th>
                                <td>${region.AnswerRate ? (region.AnswerRate * 100).toFixed(1) + '%' : '---'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;

            $('#regionDetailsModal').modal('show');
        }

        // مقداردهی اولیه نمودارها
        function initializeCharts() {
            // نمودار تماس‌ها بر اساس قاره
            const continentCtx = document.getElementById('continent-chart').getContext('2d');
            continentChart = new Chart(continentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['آسیا', 'اروپا', 'آفریقا', 'آمریکا', 'خاورمیانه', 'اقیانوسیه'],
                    datasets: [{
                        data: @Html.Raw(Json.Serialize(Model.ContinentData ?? new List<int> { 30, 25, 15, 20, 7, 3 })),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // نمودار تماس‌های بین‌المللی در مقابل داخلی
            const domesticIntlCtx = document.getElementById('domestic-intl-chart').getContext('2d');
            domesticIntlChart = new Chart(domesticIntlCtx, {
                type: 'bar',
                data: {
                    labels: ['داخلی', 'بین‌المللی'],
                    datasets: [{
                        label: 'تعداد تماس‌ها',
                        data: @Html.Raw(Json.Serialize(Model.DomesticIntlData ?? new List<int> { 65, 35 })),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 99, 132, 0.2)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // نمودار مسافت‌های تماس
            const distanceCtx = document.getElementById('distance-chart').getContext('2d');
            distanceChart = new Chart(distanceCtx, {
                type: 'line',
                data: {
                    labels: ['0-100km', '100-500km', '500-1000km', '1000-5000km', '5000km+'],
                    datasets: [{
                        label: 'تعداد تماس‌ها',
                        data: @Html.Raw(Json.Serialize(Model.DistanceData ?? new List<int> { 40, 30, 15, 10, 5 })),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // رویداد تغییر نوع نمایش
        document.getElementById('visualization-type').addEventListener('change', function() {
            const visualizationType = this.value;
            const mapData = @Html.Raw(Json.Serialize(Model.MapData?.Points ?? new List<MapViewModel.MapPoint>()));

            switch (visualizationType) {
                case 'heat':
                    showHeatMap(mapData);
                    break;
                case 'bubble':
                    showBubbleMap(mapData);
                    break;
                case 'choropleth':
                    showChoroplethMap(mapData);
                    break;
            }
        });

        // کنترل‌های نقشه
        document.getElementById('zoom-in').addEventListener('click', function() {
            map.zoomIn();
        });

        document.getElementById('zoom-out').addEventListener('click', function() {
            map.zoomOut();
        });

        document.getElementById('reset-map').addEventListener('click', function() {
            map.setView([30, 0], 2);
        });

        // خروجی نقشه
        document.getElementById('export-map').addEventListener('click', function() {
            html2canvas(document.getElementById('world-map')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'geographic-analysis.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // تمام صفحه
        document.getElementById('fullscreen-toggle').addEventListener('click', function() {
            const elem = document.getElementById('world-map');

            if (!document.fullscreenElement) {
                elem.requestFullscreen().then(() => {
                    this.innerHTML = '<i class="fas fa-compress"></i> خروج از تمام صفحه';
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 500);
                }).catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen().then(() => {
                    this.innerHTML = '<i class="fas fa-expand"></i> تمام صفحه';
                    setTimeout(() => {
                        map.invalidateSize();
                    }, 500);
                });
            }
        });

        // مقداردهی اولیه
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
        });
    </script>
}